/**
 * Angularjs directive for french immmatriculation input
 * @version v1.0.0 - 2015-08-21
 * @link 
 * @author Christophe genin <genin.christophe@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("cg.immatriculation",[]).directive("cgImmatriculation",[function(){var a=["input","keyup","click","focus"],b=new RegExp("[A-Z]{1}"),c=new RegExp("[0-9]{1}"),d=function(a){var d="__-___-__",e=/[A-Z]{2}\-[0-9]{3}\-[A-Z]{2}/g,f=d.split(""),g=a.split(""),h="",i=0,j=[];angular.forEach(f,function(a,d){if(g[d]){var e=angular.uppercase(""+g[d]);0!==d&&1!==d&&7!==d&&8!==d||!b.test(e)||(0===i||i===d-1)&&(h+=e,i=d),3!==d&&4!==d&&5!==d||!c.test(e)||i===d-1&&(h+=e,i=d)}h.length!==d+1&&(h+=a,"-"===a&&(i+1===d&&(i=d),j.push(d)))}),i++;var k=e.test(h);return console.log(k),{position:i,value:h,defaultMask:d,forbiddenPos:j,maxposition:d.length-1,regexp:e,valid:k}},e=function(a){return a===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(a.type||a.href||~a.tabIndex)};return{priority:100,require:"ngModel",restrict:"A",link:function(b,c,f,g){function h(){var a=c.val();a&&0!=a.length||(c.val(""),g.$setViewValue(""))}function i(a){if(!a)return 0;if(void 0!==a.selectionStart)return a.selectionStart;if(document.selection&&e(c[0])){a.focus();var b=document.selection.createRange();return b.moveStart("character",a.value?-a.value.length:0),b.text.length}return 0}function j(a,b){if(!a)return 0;if(0!==a.offsetWidth&&0!==a.offsetHeight)if(a.setSelectionRange)e(c[0])&&(a.focus(),a.setSelectionRange(b,b));else if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",b),d.moveStart("character",b),d.select()}}function k(a){return a?void 0!==a.selectionStart?a.selectionEnd-a.selectionStart:document.selection?document.selection.createRange().text.length:0:0}function l(a){a=a||{};var b=a.which,e=a.type;if(16!==b&&91!==b){var h=c.val(),l=i(this)||0,m=o||0,n=l-m,q=d(h),s=p||0,t=k(this)>0,u=s>0,v=h.length<r.length||s&&h.length===r.length-s,w=b>=37&&40>=b&&a.shiftKey,x=37===b,y=46===b||"keyup"!==e&&v&&0===n&&!u,z=function(a){for(var b=0;b<q.forbiddenPos.length;b++){var c=q.forbiddenPos[b];if(c===a&&!y&&!x)return a+1}return a};if(!w&&(!t||"click"!==e&&"keyup"!==e))return c.attr("ng-pattern",q.regexp),c.val(q.value),g.$setViewValue(q.value),g.$setValidity(f.ngModel,q.valid),r=q.value.substring(0,q.position),q.defaultMask===q.value?void j(this,0):void(l<=q.position?j(this,z(l)):j(this,z(q.position)))}}function m(){q||(c.bind("blur",h),c.bind(a.join(" "),l),q=!0)}function n(){var a=g.$modelValue||"",b=d(a);return b.defaultMask!==b.value&&(c.val(valMasked.value),g.$setViewValue(valMasked.value)),m(),!0}var o,p,q=!1,r="";c.attr("placeholder","Immatriculation"),g.$render=function(){if(g.$viewValue){var a=d(g.$viewValue);a.value!==g.$viewValue&&(g.$setViewValue(a.value),g.$setValidity(f.ngModel,a.valid)),c.val(a.value)}else c.val("")},f.$observe("cgImmatriculation",n)}}}]);